<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SentinelMine ‚Äî AI Rockfall Prediction</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background:#f8f9fa; }
    .navbar { background:#2c3e50; }
    .navbar-brand { color:#fff !important; font-weight:600; }
    .feature-card { padding:12px 14px; margin:8px 0; border-radius:10px; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.06);}
    .result-box { padding:18px; border-radius:12px; color:#fff; text-align:center; margin-top:10px; transition: all 300ms ease; }
    .green { background:#27ae60; }
    .yellow { background:#f1c40f; color:#000; }
    .red { background:#e74c3c; }
    .led { display:inline-block; width:14px; height:14px; border-radius:50%; margin-right:8px; vertical-align:middle; transition: background 300ms ease; }
    .zone-panel { background:#fff; padding:12px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.06); margin-bottom:16px; }
    .slider-value { margin-left:8px; font-weight:600; color:#2c3e50; }
    .zone-title { font-weight:700; margin-bottom:8px; }
    .fade-in { animation: fadeIn 400ms ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity:1; transform:none; } }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <span class="navbar-brand">‚õèÔ∏è SentinelMine ‚Äî Rockfall Prediction</span>
      <div class="ms-auto text-white">
        Mode:
        <div class="btn-group btn-group-sm" role="group" aria-label="mode">
          <input type="radio" class="btn-check" name="mode" id="modeGlobal" autocomplete="off" checked>
          <label class="btn btn-outline-light btn-sm" for="modeGlobal">Global</label>
          <input type="radio" class="btn-check" name="mode" id="modeZone" autocomplete="off">
          <label class="btn btn-outline-light btn-sm" for="modeZone">Zones</label>
        </div>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- GLOBAL MODE -->
    <div id="globalUI">
      <div class="row">
        <div class="col-md-6">
          <h4>‚öôÔ∏è Sensor Controls (Global)</h4>
          <div id="form"></div>
        </div>

        <div class="col-md-6">
          <h4>üìä Prediction Result (Global)</h4>
          <div id="output" style="display:none;">
            <div id="alertBox" class="result-box fade-in">
              <div><span id="led" class="led"></span><span id="alertText"></span></div>
              <h5 id="messageText" class="mt-2"></h5>
              <canvas id="gaugeChart" width="250" height="250"></canvas>
              <p class="mt-2">Risk Probability: <span id="probVal"></span></p>
            </div>
          </div>

          <h5 class="mt-3">üìú Recent Prediction History (Global)</h5>
          <ul class="list-group" id="historyList"></ul>
          <button class="btn btn-link mt-2" id="viewFullGlobal">View Full History</button>
        </div>
      </div>
    </div>

    <!-- ZONE MODE -->
    <div id="zoneUI" style="display:none;">
      <h4>üó∫Ô∏è Zones</h4>
      <div id="zonesContainer"></div>
    </div>
  </div>

<!-- Full History Modal -->
<div class="modal fade" id="fullHistoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Full Prediction History</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <h6>Global History</h6>
        <ul id="fullGlobal" class="list-group mb-3"></ul>
        <h6>Per-zone History</h6>
        <div id="fullZones"></div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const features = {{ features|tojson }};
  let globalHistory = [];
  let zoneHistoryStore = {};

  const modeGlobal = document.getElementById('modeGlobal');
  const modeZone = document.getElementById('modeZone');
  const globalUI = document.getElementById('globalUI');
  const zoneUI = document.getElementById('zoneUI');

  modeGlobal.addEventListener('change', () => { globalUI.style.display = 'block'; zoneUI.style.display = 'none'; });
  modeZone.addEventListener('change', () => { globalUI.style.display = 'none'; zoneUI.style.display = 'block'; if (!window.zonesLoaded) loadZones(); });

  // ---------- GLOBAL UI ----------
  const formDiv = document.getElementById('form');
  features.forEach(f => {
    const container = document.createElement('div');
    container.className = 'feature-card fade-in';
    const label = document.createElement('label'); label.innerText = f.name; label.style.display='block'; label.style.fontWeight='600';
    const input = document.createElement('input'); input.type='range'; input.className='form-range';
    input.min = f.min_r; input.max = f.max_r; input.step = (f.max_r - f.min_r)/100.0 || 1; input.value = f.mean_r;
    input.id = 'inp_' + f.name.replace(/\s+/g,'_');
    const valspan = document.createElement('span'); valspan.className='slider-value'; valspan.id = 'val_' + f.name.replace(/\s+/g,'_'); valspan.innerText = input.value;
    input.oninput = () => { valspan.innerText = input.value; makePredict(); };
    container.appendChild(label); container.appendChild(input); container.appendChild(valspan);
    formDiv.appendChild(container);
  });

  let gaugeChart = new Chart(document.getElementById('gaugeChart'), {
    type: 'doughnut',
    data: { labels: ['Risk','Safe'], datasets:[{ data:[0,100], backgroundColor:['#e74c3c','#bdc3c7'], borderWidth:0 }] },
    options: { cutout: '70%', plugins:{ legend:{ display:false } } }
  });

  async function makePredict(){
    const payload = {};
    features.forEach(f => {
      const id = 'inp_' + f.name.replace(/\s+/g,'_');
      const el = document.getElementById(id);
      if (el) payload[f.name] = parseFloat(el.value);
    });
    const res = await fetch('/predict', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
    const j = await res.json();
    document.getElementById('output').style.display = 'block';
    document.getElementById('probVal').innerText = (j.probability*100).toFixed(2) + '%';
    document.getElementById('messageText').innerText = j.message;
    const alertBox = document.getElementById('alertBox'); const led = document.getElementById('led'); const alertText = document.getElementById('alertText');
    if (j.alert === 'GREEN') { alertBox.className='result-box green fade-in'; led.style.background='#145a32'; alertText.innerText=' SAFE'; }
    else if (j.alert === 'YELLOW') { alertBox.className='result-box yellow fade-in'; led.style.background='#b7950b'; alertText.innerText=' POTENTIAL RISK'; }
    else { alertBox.className='result-box red fade-in'; led.style.background='#7b241c'; alertText.innerText=' HIGH RISK'; }
    gaugeChart.data.datasets[0].data = [j.probability*100, 100 - j.probability*100]; gaugeChart.update();

    const item = { ts: new Date().toISOString(), alert: j.alert, prob: j.probability };
    globalHistory.unshift(item);
    const recent = globalHistory.slice(0,5);
    const ul = document.getElementById('historyList'); ul.innerHTML = '';
    recent.forEach(it => {
      const li = document.createElement('li'); li.className='list-group-item'; li.innerText = new Date(it.ts).toLocaleTimeString() + ' ‚Üí ' + it.alert + ' (' + (it.prob*100).toFixed(1) + '%)';
      ul.appendChild(li);
    });
  }
  makePredict();

  document.getElementById('viewFullGlobal').addEventListener('click', () => {
    const ul = document.getElementById('fullGlobal'); ul.innerHTML = '';
    globalHistory.forEach(it => {
      const li = document.createElement('li'); li.className='list-group-item'; li.innerText = new Date(it.ts).toLocaleString() + ' ‚Üí ' + it.alert + ' (' + (it.prob*100).toFixed(1) + '%)';
      ul.appendChild(li);
    });
    const fullZonesDiv = document.getElementById('fullZones'); fullZonesDiv.innerHTML = '';
    for (const z in zoneHistoryStore) {
      fullZonesDiv.innerHTML += `<h6>Zone ${z}</h6><ul class="list-group mb-3">${zoneHistoryStore[z].map(it => `<li class="list-group-item">${new Date(it.ts).toLocaleString()} ‚Üí ${it.alert} (${(it.prob*100).toFixed(1)}%)</li>`).join('')}</ul>`;
    }
    const modal = new bootstrap.Modal(document.getElementById('fullHistoryModal'));
    modal.show();
  });

  // ---------------- ZONE MODE ----------------
  async function loadZones(){
    const res = await fetch('/zones');
    const obj = await res.json();
    const zones = obj.zones && obj.zones.length ? obj.zones : ['A1','A2','B1','B2','C1'];
    const featuresForZones = features.map(f => ({ name: f.name, min_r: f.min_r, max_r: f.max_r, mean_r: f.mean_r }));
    const container = document.getElementById('zonesContainer'); container.innerHTML = '';
    window.zonesLoaded = true;
    zones.forEach(zone => {
      const row = document.createElement('div'); row.className = 'row zone-panel fade-in';
      const left = document.createElement('div'); left.className = 'col-md-6';
      const lt = document.createElement('h5'); lt.innerText = `Zone ${zone} ‚Äî Sensors`; left.appendChild(lt);
      featuresForZones.forEach(f => {
        const card = document.createElement('div'); card.className='feature-card';
        const label = document.createElement('label'); label.innerText = f.name; label.style.display='block'; label.style.fontWeight='600';
        const input = document.createElement('input'); input.type='range'; input.className='form-range';
        input.min = f.min_r; input.max = f.max_r; input.step = (f.max_r - f.min_r)/100.0 || 1; input.value = f.mean_r;
        const safeF = f.name.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_]/g,'');
        input.id = `zone_${zone}__${safeF}`;
        const valspan = document.createElement('span'); valspan.className='slider-value'; valspan.id = `val_zone_${zone}__${safeF}`; valspan.innerText = input.value;
        input.oninput = () => { valspan.innerText = input.value; makeZonePredict(zone); };
        card.appendChild(label); card.appendChild(input); card.appendChild(valspan);
        left.appendChild(card);
      });

      const right = document.createElement('div'); right.className = 'col-md-6';
      const rt = document.createElement('h5'); rt.innerText = `Zone ${zone} ‚Äî Status`; right.appendChild(rt);
      const resultBox = document.createElement('div'); resultBox.id = `zone_result_${zone}`; resultBox.className = 'result-box green';
      const ledWrap = document.createElement('div');
      const led = document.createElement('span'); led.className='led'; led.id = `zone_led_${zone}`; led.style.background='#145a32';
      const txt = document.createElement('span'); txt.id = `zone_text_${zone}`; txt.innerText=' SAFE';
      ledWrap.appendChild(led); ledWrap.appendChild(txt);
      const msg = document.createElement('h6'); msg.id = `zone_msg_${zone}`; msg.className='mt-2';
      const canvas = document.createElement('canvas'); canvas.id = `gauge_${zone}`; canvas.width=220; canvas.height=220;
      const probP = document.createElement('p'); probP.innerHTML = 'Risk Probability: <span id="zone_prob_'+zone+'">--</span>';
      resultBox.appendChild(ledWrap); resultBox.appendChild(msg); resultBox.appendChild(canvas); resultBox.appendChild(probP);
      right.appendChild(resultBox);

      const titleH = document.createElement('h6'); titleH.innerText='Recent History';
      const hlist = document.createElement('ul'); hlist.className='list-group'; hlist.id = `zone_history_recent_${zone}`;
      const viewFullBtn = document.createElement('button'); viewFullBtn.className='btn btn-link mt-2'; viewFullBtn.innerText='View Full History';
      viewFullBtn.onclick = () => {
        document.getElementById('fullGlobal').innerHTML = globalHistory.map(it => `<li class="list-group-item">${new Date(it.ts).toLocaleString()} ‚Üí ${it.alert} (${(it.prob*100).toFixed(1)}%)</li>`).join('');
        const fullZonesDiv = document.getElementById('fullZones'); fullZonesDiv.innerHTML = '';
        for (const z in zoneHistoryStore) {
          fullZonesDiv.innerHTML += `<h6>Zone ${z}</h6><ul class="list-group mb-3">${zoneHistoryStore[z].map(it => `<li class="list-group-item">${new Date(it.ts).toLocaleString()} ‚Üí ${it.alert} (${(it.prob*100).toFixed(1)}%)</li>`).join('')}</ul>`;
        }
        const modal = new bootstrap.Modal(document.getElementById('fullHistoryModal'));
        modal.show();
      };

      right.appendChild(titleH); right.appendChild(hlist); right.appendChild(viewFullBtn);

      row.appendChild(left); row.appendChild(right);
      container.appendChild(row);

      createZoneChart(zone);
      zoneHistoryStore[zone] = [];
      makeZonePredict(zone);
    });
  }

  const zoneCharts = {};
  function createZoneChart(zone){
    const ctx = document.getElementById(`gauge_${zone}`);
    const c = new Chart(ctx, {
      type: 'doughnut',
      data: { labels:['Risk','Safe'], datasets:[{ data:[0,100], backgroundColor:['#e74c3c','#bdc3c7'], borderWidth:0 }] },
      options: { cutout:'70%', plugins:{ legend:{ display:false } } }
    });
    zoneCharts[zone] = c;
  }

  async function makeZonePredict(zoneName){
    const readings = {};
    features.forEach(f => {
      const safeF = f.name.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_]/g,'');
      const el = document.getElementById(`zone_${zoneName}__${safeF}`);
      if (el) readings[f.name] = parseFloat(el.value);
    });
    const payload = {}; payload[zoneName] = readings;
    const res = await fetch('/predict', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
    const j = await res.json();
    const zoneRes = (j.zones && j.zones[zoneName]) ? j.zones[zoneName] : (j.probability !== undefined ? j : null);
    let final = zoneRes;
    if (!final) {
      const demo = demoScore(readings);
      final = { probability: demo, alert: (demo<0.3?'GREEN':(demo<0.7?'YELLOW':'RED')), message:'Demo fallback' };
    }
    const prob = final.probability;
    document.getElementById(`zone_prob_${zoneName}`).innerText = (prob*100).toFixed(1) + '%';
    document.getElementById(`zone_msg_${zoneName}`).innerText = final.message || '';
    const led = document.getElementById(`zone_led_${zoneName}`); const txt = document.getElementById(`zone_text_${zoneName}`);
    const resBox = document.getElementById(`zone_result_${zoneName}`);
    if (final.alert === 'GREEN') { resBox.className='result-box green fade-in'; led.style.background='#145a32'; txt.innerText=' SAFE'; }
    else if (final.alert === 'YELLOW') { resBox.className='result-box yellow fade-in'; led.style.background='#b7950b'; txt.innerText=' POTENTIAL RISK'; }
    else { resBox.className='result-box red fade-in'; led.style.background='#7b241c'; txt.innerText=' HIGH RISK'; }

    const chart = zoneCharts[zoneName];
    if (chart) { chart.data.datasets[0].data = [prob*100, 100 - prob*100]; chart.update(); }

    const item = { ts: new Date().toISOString(), alert: final.alert, prob: final.probability };
    zoneHistoryStore[zoneName].unshift(item);
    const recent = zoneHistoryStore[zoneName].slice(0,5);
    const ul = document.getElementById(`zone_history_recent_${zoneName}`); ul.innerHTML = '';
    recent.forEach(it => {
      const li = document.createElement('li'); li.className='list-group-item'; li.innerText = new Date(it.ts).toLocaleTimeString() + ' ‚Üí ' + it.alert + ' (' + (it.prob*100).toFixed(1) + '%)';
      ul.appendChild(li);
    });
  }

  function demoScore(readings){
    let score = 0;
    const weights = { "Rainfall_mm":0.15, "Slope_Angle":0.10, "Soil_Saturation":0.20, "Vegetation_Cover":-0.10, "Earthquake_Activity":0.30, "Proximity_to_Water":0.15 };
    for (const f in readings){
      const w = weights[f] !== undefined ? weights[f] : 0.1;
      const v = parseFloat(readings[f]) || 0;
      score += (v/100.0) * w;
    }
    return Math.max(0, Math.min(1, score));
  }

</script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SentinelMine ‚Äî AI Disaster Risk Prediction</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background:#f8f9fa; }
    .navbar { background:#2c3e50; }
    .navbar-brand { color:#fff !important; font-weight:600; }
    .feature-card { padding:15px; margin:10px; border-radius:12px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
    .result-box { padding:20px; border-radius:12px; color:#fff; text-align:center; margin-top:20px; }
    .green { background:#27ae60; }
    .yellow { background:#f1c40f; color:#000; }
    .red { background:#e74c3c; }
    .led { display:inline-block; width:18px; height:18px; border-radius:50%; margin-right:8px; vertical-align:middle; }
    #history { margin-top:30px; }
    .small-muted { font-size:0.85rem; color:#6c757d; }
    .mine-caption { font-size:0.9rem; color:#555; margin-top:8px; }

    /* SVG zone base styles */
    .mine-svg { width:100%; max-width:720px; height:auto; display:block; margin-top:12px; }
    .zone { fill: rgba(255,255,255,0.03); stroke: rgba(0,0,0,0.08); stroke-width:1; transition: fill 300ms ease, filter 300ms ease, transform 300ms ease; }
    .zone-label { font-size:12px; fill:#222; pointer-events:none; }

    /* highlight states */
    .zone.highlight-yellow { fill: rgba(241,196,15,0.55); filter: drop-shadow(0 6px 14px rgba(241,196,15,0.18)); transform: scale(1.03); }
    .zone.highlight-red { fill: rgba(231,76,60,0.65); filter: drop-shadow(0 8px 18px rgba(231,76,60,0.22)); transform: scale(1.06); }

    /* pulsing animation for critical highlights */
    @keyframes pulse-strong {
      0% { box-shadow: 0 0 0 0 rgba(231,76,60,0.25); }
      70% { box-shadow: 0 0 0 18px rgba(231,76,60,0); }
      100% { box-shadow: 0 0 0 0 rgba(231,76,60,0); }
    }
    /* apply to an overlay circle for pulse - we add a separate <circle> as pulse indicator if needed */
    .pulse-circle { animation: pulse-strong 1600ms infinite; opacity:0.95; }

    /* small helper for All Clear badge */
    .all-clear-badge { display:inline-block; padding:6px 10px; border-radius:8px; background:rgba(39,174,96,0.12); color:#27ae60; font-weight:600; margin-top:6px; }
    .minimap-wrap { margin-top:12px; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand">‚õèÔ∏è SentinelMine Risk Monitor</a>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="row">
      <!-- Input (left) -->
      <div class="col-md-6">
        <h4 class="mb-3">‚öôÔ∏è Sensor Controls</h4>
        <div class="row" id="form"></div>
      </div>

      <!-- Output (right) -->
      <div class="col-md-6">
        <h4 class="mb-3">üìä Prediction Result</h4>
        <div id="output" style="display:none;">
          <div id="alertBox" class="result-box">
            <div><span id="led" class="led"></span><span id="alertText"></span></div>
            <h5 id="messageText" class="mt-2"></h5>
            <canvas id="gaugeChart" width="250" height="250"></canvas>
            <p class="mt-2">Risk Probability: <span id="probVal"></span></p>
          </div>
        </div>

        <!-- Recent history (max 5) -->
        <div id="history" class="mt-4">
          <h5>üìú Recent Predictions</h5>
          <ul class="list-group" id="historyList"></ul>
          <div class="d-flex justify-content-between align-items-center mt-2">
            <small class="small-muted">Showing latest 5</small>
            <button type="button" id="viewFullBtn" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#fullHistoryModal">
              View full history
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Mine (SVG top-view) -->
    <div class="mt-5">
      <h4>‚õèÔ∏è Mine Risk Map (top view)</h4>
      <div class="minimap-wrap">
        <!-- Static SVG: terraces + 6 zones that we will highlight by toggling classes -->
        <svg id="mineSvg" class="mine-svg" viewBox="0 0 720 380" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Top view open pit mine">
          <!-- Background terraces (cone-shaped: draw outermost first, then inner) -->
          <ellipse cx="360" cy="290" rx="300" ry="70" fill="#dfe6e9"/>
          <ellipse cx="360" cy="260" rx="260" ry="58" fill="#e9ecef"/>
          <ellipse cx="360" cy="230" rx="215" ry="48" fill="#d6d6d6"/>
          <ellipse cx="360" cy="200" rx="165" ry="40" fill="#cfcfcf"/>
          <ellipse cx="360" cy="170" rx="120" ry="30" fill="#c2c2c2"/>

          <!-- inner pit -->
          <ellipse cx="360" cy="320" rx="250" ry="56" fill="#f6f7f8" opacity="0.9"/>

          <!-- Zones (top-view ovals). IDs used by JS -->
          <g id="zonesGroup">
            <ellipse id="Z1" class="zone" cx="250" cy="210" rx="90" ry="28"/>
            <text x="250" y="210" class="zone-label" text-anchor="middle" dy="4">Z1</text>

            <ellipse id="Z2" class="zone" cx="360" cy="170" rx="110" ry="30"/>
            <text x="360" y="170" class="zone-label" text-anchor="middle" dy="4">Z2</text>

            <ellipse id="Z3" class="zone" cx="480" cy="200" rx="82" ry="26"/>
            <text x="480" y="200" class="zone-label" text-anchor="middle" dy="4">Z3</text>

            <ellipse id="Z4" class="zone" cx="300" cy="260" rx="140" ry="36"/>
            <text x="300" y="260" class="zone-label" text-anchor="middle" dy="4">Z4</text>

            <ellipse id="Z5" class="zone" cx="420" cy="250" rx="120" ry="32"/>
            <text x="420" y="250" class="zone-label" text-anchor="middle" dy="4">Z5</text>

            <ellipse id="Z6" class="zone" cx="360" cy="100" rx="70" ry="22"/>
            <text x="360" y="100" class="zone-label" text-anchor="middle" dy="4">Z6</text>
          </g>

          <!-- Pulse circles (hidden by default). Each maps to a zone ID like pulse-Z1 -->
          <g id="pulseGroup" pointer-events="none">
            <circle id="pulse-Z1" cx="250" cy="210" r="50" class="pulse-circle" style="display:none; fill:rgba(231,76,60,0.12)"/>
            <circle id="pulse-Z2" cx="360" cy="170" r="62" class="pulse-circle" style="display:none; fill:rgba(241,196,15,0.12)"/>
            <circle id="pulse-Z3" cx="480" cy="200" r="44" class="pulse-circle" style="display:none; fill:rgba(231,76,60,0.12)"/>
            <circle id="pulse-Z4" cx="300" cy="260" r="74" class="pulse-circle" style="display:none; fill:rgba(241,196,15,0.12)"/>
            <circle id="pulse-Z5" cx="420" cy="250" r="66" class="pulse-circle" style="display:none; fill:rgba(231,76,60,0.12)"/>
            <circle id="pulse-Z6" cx="360" cy="100" r="38" class="pulse-circle" style="display:none; fill:rgba(241,196,15,0.12)"/>
          </g>
        </svg>
      </div>

      <div style="margin-top:6px;">
        <span id="allClearBadge" class="all-clear-badge" style="display:none;">All Clear</span>
        <span id="mineStatus" class="small-muted" style="margin-left:8px;">Simulation status will update after each slider change.</span>
      </div>
      <p class="mine-caption">Top view schematic: highlighted zones indicate likely area(s) of rockfall/landslide. Higher risk increases chance and intensity of highlights.</p>
    </div>
  </div>

  <!-- Full history modal -->
  <div class="modal fade" id="fullHistoryModal" tabindex="-1" aria-labelledby="fullHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="fullHistoryModalLabel">Full Prediction History</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <ul class="list-group" id="fullHistoryList"></ul>
        </div>
        <div class="modal-footer">
          <button type="button" id="clearHistoryBtn" class="btn btn-danger btn-sm">Clear History</button>
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ---------- Frontend logic: sliders, predict, history ---------- */
const features = {{ features|tojson }};
const formDiv = document.getElementById('form');
const fullHistory = [];  // most recent first

// Build UI sliders / selects
features.forEach(f => {
  const col = document.createElement('div');
  col.className = 'col-md-6';
  const card = document.createElement('div');
  card.className = 'feature-card';

  const label = document.createElement('label');
  label.innerText = f.name;
  label.className = 'form-label';
  card.appendChild(label);

  if (f.type === 'numeric') {
    const input = document.createElement('input');
    input.type = 'range';
    input.className = 'form-range';
    input.min = f.min_r;
    input.max = f.max_r;
    input.step = Math.max((f.max_r - f.min_r) / 100.0, 0.0001);
    input.value = f.mean_r;
    input.id = 'inp_' + f.name;

    const valspan = document.createElement('span');
    valspan.id = 'val_' + f.name;
    valspan.innerText = Number(input.value).toFixed(3);

    input.oninput = () => { valspan.innerText = Number(input.value).toFixed(3); makePredict(); };

    card.appendChild(input);
    card.appendChild(document.createElement('br'));
    card.appendChild(valspan);
  } else {
    const sel = document.createElement('select');
    sel.className = 'form-select';
    sel.id = 'inp_' + f.name;
    (f.options || []).forEach(opt => {
      const o = document.createElement('option');
      o.value = opt; o.text = opt;
      sel.appendChild(o);
    });
    sel.onchange = makePredict;
    card.appendChild(sel);
  }

  col.appendChild(card);
  formDiv.appendChild(col);
});

// Chart gauge
let gaugeChart = new Chart(document.getElementById('gaugeChart'), {
  type: 'doughnut',
  data: {
    labels: ['Risk', 'Safe'],
    datasets: [{
      data: [0, 100],
      backgroundColor: ['#e74c3c', '#bdc3c7'],
      borderWidth: 0
    }]
  },
  options: { cutout: '70%', plugins: { legend: { display: false } } }
});

// History rendering
function renderRecent() {
  const list = document.getElementById('historyList');
  list.innerHTML = '';
  const recent = fullHistory.slice(0,5);
  if (recent.length === 0) {
    const li = document.createElement('li'); li.className='list-group-item small-muted';
    li.innerText = 'No history yet ‚Äî move sliders to generate predictions';
    list.appendChild(li); return;
  }
  recent.forEach(it => {
    const li = document.createElement('li'); li.className='list-group-item';
    li.innerHTML = `<strong>${it.ts}</strong> ‚Üí ${it.alert} <span class="small-muted">(${(it.prob*100).toFixed(1)}%)</span><div class="small-muted">${it.message}</div>`;
    list.appendChild(li);
  });
}
function renderFullHistory() {
  const full = document.getElementById('fullHistoryList'); full.innerHTML='';
  if (fullHistory.length===0) {
    const li = document.createElement('li'); li.className='list-group-item small-muted'; li.innerText='No history available'; full.appendChild(li); return;
  }
  fullHistory.forEach(it => {
    const li = document.createElement('li'); li.className='list-group-item';
    const dbg = JSON.stringify(it.debug||{}, null, 2);
    li.innerHTML = `<div class="d-flex justify-content-between"><div><strong>${it.ts}</strong> ‚Üí ${it.alert} <small class="small-muted">(${(it.prob*100).toFixed(1)}%)</small></div><div><small class="small-muted">${it.message}</small></div></div><pre class="debug-box mt-2">${dbg}</pre>`;
    full.appendChild(li);
  });
}

// Clear history button
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('clearHistoryBtn').addEventListener('click', () => {
    if (!confirm('Clear the full history? This cannot be undone in this session.')) return;
    fullHistory.length = 0; renderRecent(); renderFullHistory();
  });
});

// Prediction call
async function makePredict(){
  const payload = {};
  features.forEach(f => {
    const el = document.getElementById('inp_' + f.name);
    if (!el) return;
    payload[f.name] = (f.type === 'numeric') ? parseFloat(el.value) : el.value;
  });

  try {
    const res = await fetch('/predict', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    const j = await res.json();

    document.getElementById('output').style.display = 'block';
    document.getElementById('probVal').innerText = (j.probability*100).toFixed(2) + '%';
    document.getElementById('messageText').innerText = j.message;

    const alertBox = document.getElementById('alertBox'), led = document.getElementById('led'), alertText = document.getElementById('alertText');
    if (j.alert === 'GREEN') { alertBox.className='result-box green'; led.style.background='#145a32'; alertText.innerText=' SAFE'; }
    else if (j.alert === 'YELLOW') { alertBox.className='result-box yellow'; led.style.background='#b7950b'; alertText.innerText=' POTENTIAL RISK'; }
    else { alertBox.className='result-box red'; led.style.background='#7b241c'; alertText.innerText=' HIGH RISK'; }

    // gauge
    gaugeChart.data.datasets[0].data = [j.probability*100, 100 - j.probability*100]; gaugeChart.update();

    // history
    const entry = { ts: new Date().toLocaleString(), alert: j.alert, prob: j.probability, message: j.message, debug: j.debug||{} };
    fullHistory.unshift(entry); if (fullHistory.length>500) fullHistory.pop();
    renderRecent(); renderFullHistory();

    // update mine map highlights (no redraw of SVG; just toggle classes)
    updateMineHighlights(j.probability);

  } catch(err) {
    console.error('Prediction error', err);
  }
}

// ensure initial predict on load
document.addEventListener('DOMContentLoaded', () => { makePredict(); });

// -------------------- SVG zone highlighting logic --------------------

/*
  Strategy:
  - We have zones Z1..Z6 as SVG <ellipse> elements.
  - On each update we remove previous highlight classes and set new ones:
      - For low risk: usually no highlight (show "All Clear")
      - medium risk: 1 zone highlighted (yellow)
      - high risk: 1-2 zones highlighted (red or red+yellow), and show pulse on critical zones
  - Selection is random but weighted by risk, so higher risk makes highlights more likely.
  - We do NOT recreate SVG elements; we only toggle CSS classes and show/hide pulse circles.
*/

const zoneIds = ['Z1','Z2','Z3','Z4','Z5','Z6'];

function resetMineHighlights(){
  zoneIds.forEach(id=>{
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.remove('highlight-red','highlight-yellow');
    // hide pulse circle if exists
    const pulse = document.getElementById('pulse-'+id);
    if (pulse) pulse.style.display = 'none';
  });
  document.getElementById('allClearBadge').style.display = 'none';
  document.getElementById('mineStatus').innerText = 'Simulation status will update after each slider change.';
}

// main update function
function updateMineHighlights(prob){
  // clamp
  const p = Math.max(0, Math.min(1, prob || 0));
  resetMineHighlights();

  // decide number of highlights
  let count = 0;
  if (p < 0.12) {
    count = (Math.random() < p*2) ? 1 : 0; // very unlikely
  } else if (p < 0.4) {
    count = (Math.random() < p*1.1) ? 1 : 0;
  } else if (p < 0.7) {
    count = (Math.random() < p) ? 1 : 0;
  } else {
    const r = Math.random();
    if (r < 0.6) count = 1;
    else if (r < 0.95) count = 2;
    else count = 3;
  }

  if (count === 0) {
    // all-clear UI
    document.getElementById('allClearBadge').style.display = 'inline-block';
    document.getElementById('mineStatus').innerText = 'Most likely no rockfall ‚Äî all clear.';
    return;
  }

  // choose distinct zones randomly (shuffle indices)
  const indices = [...Array(zoneIds.length).keys()];
  for (let i = indices.length -1; i>0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [indices[i], indices[j]] = [indices[j], indices[i]];
  }

  // choose 'count' zones from shuffled list, but weight chance by p and a small zone factor
  const chosen = [];
  for (let k=0; k<indices.length && chosen.length < count; k++){
    const idx = indices[k];
    const zoneFactor = 0.6 + 0.8*Math.random();
    if (Math.random() < Math.min(1, p * zoneFactor + 0.05)) {
      chosen.push(zoneIds[idx]);
    }
  }
  // ensure at least one if none chosen but count>0
  if (chosen.length === 0) chosen.push(zoneIds[indices[0]]);

  // Apply highlights. For highest-prob zones use red + pulse, for others yellow
  // Sort chosen so first is most "critical"
  for (let i=0;i<chosen.length;i++){
    const id = chosen[i];
    const el = document.getElementById(id);
    if (!el) continue;
    if (p >= 0.75 && i===0) {
      el.classList.add('highlight-red');
      // show pulse circle (if exists)
      const pulse = document.getElementById('pulse-'+id);
      if (pulse) { pulse.style.display = 'block'; pulse.style.opacity = '0.95'; }
    } else {
      el.classList.add('highlight-yellow');
      const pulse = document.getElementById('pulse-'+id);
      if (pulse) { pulse.style.display = 'block'; pulse.style.opacity = '0.6'; }
    }
  }

  document.getElementById('mineStatus').innerText = `Highlighted ${chosen.length} zone(s) ‚Äî risk ${(p*100).toFixed(1)}%`;
}

// End of script
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SmartWear ‚Äî AI Disaster Risk Prediction</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background:#f8f9fa; }
    .navbar { background:#2c3e50; }
    .navbar-brand { color:#fff !important; font-weight:600; }
    .feature-card { padding:15px; margin:10px; border-radius:12px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
    .result-box { padding:20px; border-radius:12px; color:#fff; text-align:center; margin-top:20px; }
    .green { background:#27ae60; }
    .yellow { background:#f1c40f; color:#000; }
    .red { background:#e74c3c; }
    .led { display:inline-block; width:18px; height:18px; border-radius:50%; margin-right:8px; vertical-align:middle; }
    #history { margin-top:30px; }
    .zone-card { padding:15px; margin:10px; border-radius:12px; background:#ecf0f1; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand">üåç SmartWear Risk Monitor</a>
      <div class="ms-auto">
        <button id="modeBtn" class="btn btn-light">Switch to Zone Mode</button>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- Global controls (unchanged) -->
    <div id="globalMode">
      <h4 class="mb-3">‚öôÔ∏è Sensor Controls</h4>
      <div class="row" id="form"></div>
      <div id="output" style="display:none;">
        <div id="alertBox" class="result-box">
          <div><span id="led" class="led"></span><span id="alertText"></span></div>
          <h5 id="messageText" class="mt-2"></h5>
          <canvas id="gaugeChart" width="200" height="200"></canvas>
          <p class="mt-2">Risk Probability: <span id="probVal"></span></p>
        </div>
      </div>
      <div id="history">
        <h4 class="mt-4">üìú Prediction History</h4>
        <ul class="list-group" id="historyList"></ul>
      </div>
    </div>

    <!-- Zone controls (improved) -->
    <div id="zoneMode" style="display:none;">
      <h4 class="mb-3">üèóÔ∏è Mine Zones</h4>
      <div class="row" id="zoneGrid"></div>
      <h5 class="mt-4">Zone Controls</h5>
      <div id="zoneControls"></div>
      <h5 class="mt-4">Zone History</h5>
      <ul class="list-group" id="zoneHistory"></ul>
    </div>
  </div>

<script>
const features = {{ features|tojson }};
let zoneData = null;

// Mode toggle
const modeBtn = document.getElementById("modeBtn");
modeBtn.onclick = () => {
  if (document.getElementById("globalMode").style.display !== "none") {
    document.getElementById("globalMode").style.display = "none";
    document.getElementById("zoneMode").style.display = "block";
    modeBtn.innerText = "Switch to Global Mode";
    loadZones();
  } else {
    document.getElementById("globalMode").style.display = "block";
    document.getElementById("zoneMode").style.display = "none";
    modeBtn.innerText = "Switch to Zone Mode";
  }
};

// ------------------ Global Controls (same as before) ------------------
const formDiv = document.getElementById('form');
features.forEach(f => {
  const col = document.createElement('div');
  col.className = 'col-md-6';
  const card = document.createElement('div');
  card.className = 'feature-card';

  const label = document.createElement('label');
  label.innerText = f.name;
  label.className = 'form-label';
  card.appendChild(label);

  if (f.type === 'numeric') {
    const input = document.createElement('input');
    input.type = 'range';
    input.className = 'form-range';
    input.min = f.min_r;
    input.max = f.max_r;
    input.step = (f.max_r - f.min_r) / 100.0;
    input.value = f.mean_r;
    input.id = 'inp_' + f.name;

    const valspan = document.createElement('span');
    valspan.id = 'val_' + f.name;
    valspan.innerText = input.value;

    input.oninput = () => { valspan.innerText = input.value; makePredict(); };

    card.appendChild(input);
    card.appendChild(valspan);
  }
  col.appendChild(card);
  formDiv.appendChild(col);
});

// Gauge chart
let gaugeChart = new Chart(document.getElementById('gaugeChart'), {
  type: 'doughnut',
  data: { labels: ['Risk', 'Safe'], datasets: [{ data: [0, 100], backgroundColor: ['#e74c3c', '#bdc3c7'], borderWidth: 0 }] },
  options: { cutout: '70%', plugins: { legend: { display: false } } }
});

// Predict (global)
async function makePredict() {
  const payload = {};
  features.forEach(f => {
    const el = document.getElementById('inp_' + f.name);
    if (el) payload[f.name] = parseFloat(el.value);
  });
  const res = await fetch('/predict', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  const j = await res.json();
  document.getElementById('output').style.display = 'block';
  document.getElementById('probVal').innerText = (j.probability*100).toFixed(2) + '%';
  document.getElementById('messageText').innerText = j.message;
  const alertBox = document.getElementById('alertBox');
  const led = document.getElementById('led');
  const alertText = document.getElementById('alertText');
  if (j.alert === 'GREEN') { alertBox.className = 'result-box green'; led.style.background = '#145a32'; alertText.innerText = ' SAFE'; }
  else if (j.alert === 'YELLOW') { alertBox.className = 'result-box yellow'; led.style.background = '#b7950b'; alertText.innerText = ' POTENTIAL RISK'; }
  else { alertBox.className = 'result-box red'; led.style.background = '#7b241c'; alertText.innerText = ' HIGH RISK'; }
  gaugeChart.data.datasets[0].data = [j.probability*100, 100 - j.probability*100];
  gaugeChart.update();
  const li = document.createElement('li'); li.className = 'list-group-item'; li.innerText = new Date().toLocaleTimeString() + ' ‚Üí ' + j.alert + ' (' + (j.probability*100).toFixed(1) + '%)';
  document.getElementById('historyList').prepend(li);
}
makePredict();

// ------------------ Zone Controls (new/fixed) ------------------
async function loadZones() {
  const res = await fetch('/zones');
  zoneData = await res.json();
  const zoneGrid = document.getElementById("zoneGrid");
  const zoneControls = document.getElementById("zoneControls");
  zoneGrid.innerHTML = ""; zoneControls.innerHTML = "";
  zoneData.zones.forEach(z => {
    // zone buttons
    const col = document.createElement("div");
    col.className = "col-md-2";
    const btn = document.createElement("div");
    btn.className = "zone-card text-center";
    btn.innerText = z;
    col.appendChild(btn);
    zoneGrid.appendChild(col);
    // zone controls
    const card = document.createElement("div");
    card.className = "zone-card";
    card.innerHTML = `<h6>${z}</h6>`;
    zoneData.features.forEach(f => {
      const label = document.createElement("label");
      label.innerText = f;   // ‚úÖ fix for [object Object]
      label.className = "form-label";
      const input = document.createElement("input");
      input.type = "range"; input.className = "form-range";
      input.min = 0; input.max = 100; input.value = 50;
      input.id = `zone_${z}_${f}`;
      const valspan = document.createElement("span");
      valspan.id = `val_${z}_${f}`; valspan.innerText = input.value;
      input.oninput = () => { valspan.innerText = input.value; makeZonePredict(z); };
      card.appendChild(label); card.appendChild(input); card.appendChild(valspan);
    });
    zoneControls.appendChild(card);
  });
}

// Predict per zone
async function makeZonePredict(zoneName) {
  const payload = { "Zone": zoneName };
  zoneData.features.forEach(f => {
    const el = document.getElementById(`zone_${zoneName}_${f}`);
    if (el) payload[f] = parseFloat(el.value);
  });
  const res = await fetch('/predict', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  const j = await res.json();
  const li = document.createElement('li');
  li.className = 'list-group-item';
  li.innerText = `${new Date().toLocaleTimeString()} ‚Üí ${zoneName}: ${j.alert} (${(j.probability*100).toFixed(1)}%)`;
  document.getElementById('zoneHistory').prepend(li);
}
</script>
</body>
</html>